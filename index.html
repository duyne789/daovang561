<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‚õè ƒê√†o V√†ng Master - Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --p: #ffb703; --s: #fb8500; --bg: #f8f9fa; --txt: #023047; }
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--txt); user-select: none; }
        .header { background: var(--p); padding: 15px; text-align: center; font-weight: bold; font-size: 18px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .content { padding: 15px 15px 80px; }
        .card { background: #fff; padding: 20px; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); text-align: center; }
        
        .gold-val { font-size: 36px; color: var(--s); font-weight: 900; margin: 10px 0; }
        .status-text { font-size: 14px; color: #666; margin-bottom: 10px; }
        
        .prog-bg { background: #eee; height: 12px; border-radius: 6px; overflow: hidden; margin: 15px 0; border: 1px solid #ddd; }
        .prog-fill { background: linear-gradient(90deg, var(--p), var(--s)); height: 100%; width: 0%; transition: width 0.2s; }
        
        .btn { background: var(--p); border: none; padding: 15px; border-radius: 12px; width: 100%; font-weight: bold; font-size: 16px; cursor: pointer; color: var(--txt); transition: 0.2s; box-shadow: 0 4px 0 #e6a700; }
        .btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #e6a700; }
        .btn:disabled { background: #ccc; box-shadow: none; color: #888; cursor: not-allowed; }

        .nav { position: fixed; bottom: 0; width: 100%; display: flex; background: #fff; border-top: 1px solid #eee; padding-bottom: env(safe-area-inset-bottom); }
        .nav div { flex: 1; text-align: center; padding: 15px; font-size: 12px; color: #888; font-weight: bold; }
        .nav .active { color: var(--s); border-top: 3px solid var(--s); }

        input, select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: 1px solid #ddd; font-size: 14px; box-sizing: border-box; }
        label { display: block; text-align: left; font-size: 13px; font-weight: bold; color: #555; }
    </style>
</head>
<body>

<div class="header">‚õè ƒê√ÄO V√ÄNG MASTER</div>

<div class="content">
    <div id="tab-mine" class="tab">
        <div class="card">
            <div id="tool-name" style="font-size: 14px; background: #eee; display: inline-block; padding: 3px 10px; border-radius: 10px;">ƒêang t·∫£i d·ªØ li·ªáu...</div>
            <div id="gold" class="gold-val">0</div>
            <div id="status" class="status-text">S·∫µn s√†ng khai th√°c</div>
            <div class="prog-bg"><div id="prog-fill" class="prog-fill"></div></div>
            <button class="btn" id="btn-mine" onclick="startMining()">B·∫ÆT ƒê·∫¶U ƒê√ÄO</button>
        </div>
        <div class="card">
            <label>‚è± C√†i ƒë·∫∑t th·ªùi gian ƒë√†o (gi√¢y):</label>
            <input type="number" id="duration" value="30" min="30">
        </div>
    </div>

    <div id="tab-reward" class="tab" style="display:none">
        <div class="card">
            <h3>üíé ƒê·ªïi Th∆∞·ªüng</h3>
            <div style="background: #fff3cd; color: #856404; padding: 10px; border-radius: 8px; font-size: 12px; margin-bottom: 15px; text-align: left;">
                ‚Ä¢ T·ª∑ l·ªá: 20,000 v√†ng = 10,000 VNƒê<br>
                ‚Ä¢ Th·ªùi gian duy·ªát: Trong v√≤ng 24h.
            </div>
            <form onsubmit="sendWithdraw(event)">
                <select id="wd-method" onchange="updateWdPlaceholder()">
                    <option value="Momo">V√≠ Momo</option>
                    <option value="Bank">Ng√¢n h√†ng (ATM)</option>
                </select>
                <input type="text" id="wd-acc" placeholder="S·ªë ƒëi·ªán tho·∫°i Momo" required>
                <input type="text" id="wd-name" placeholder="T√™n ch·ªß t√†i kho·∫£n (VIET HOA)" required>
                <button type="submit" class="btn">G·ª¨I Y√äU C·∫¶U R√öT TI·ªÄN</button>
            </form>
        </div>
    </div>
</div>

<div class="nav">
    <div onclick="showTab('mine')" id="n-mine" class="active">‚õè ƒê√ÄO V√ÄNG</div>
    <div onclick="showTab('reward')" id="n-reward">üíé R√öT TI·ªÄN</div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // --- TH√îNG TIN ƒê√É G·∫ÆN C·ª¶A B·∫†N ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwH8_KnjdWEA-L8SGJDhYxUDBb1pIgg3EHAajvO3TSO6rQiu3OOdqEaBkniiN8wQZ1b/exec"; 
    const BOT_TOKEN = "8287339175:AAFMUbs8q8ez3Hthk7swEvpcWEEdhljhYWM";
    const CHAT_ID = "-1003681995490";
    // ------------------------------

    let gold = 0;
    let level = 0;
    let isMining = false;
    const userId = tg.initDataUnsafe?.user?.id || "guest_user";
    const userName = tg.initDataUnsafe?.user?.username || "·∫®n danh";

    const TOOLS = [
        { name: "Cu·ªëc G·ªó", power: 10 },
        { name: "Cu·ªëc S·∫Øt", power: 30 },
        { name: "M√°y Khoan", power: 80 }
    ];

    // Load d·ªØ li·ªáu t·ª´ Google Sheets
    async function loadData() {
        try {
            let res = await fetch(`${SCRIPT_URL}?userId=${userId}`);
            let data = await res.json();
            gold = parseInt(data.gold) || 0;
            level = parseInt(data.level) || 0;
            updateUI();
        } catch (e) {
            console.error("L·ªói k·∫øt n·ªëi database");
            document.getElementById("tool-name").innerText = "L·ªói k·∫øt n·ªëi!";
        }
    }

    function updateUI() {
        document.getElementById("gold").innerText = gold.toLocaleString();
        document.getElementById("tool-name").innerText = "C√¥ng c·ª•: " + (TOOLS[level]?.name || TOOLS[0].name);
    }

    async function saveData() {
        // G·ª≠i d·ªØ li·ªáu ·∫©n danh (no-cors) ƒë·ªÉ tr√°nh l·ªói b·∫£o m·∫≠t tr√¨nh duy·ªát khi g·ªçi Apps Script
        fetch(SCRIPT_URL, {
            method: "POST",
            mode: "no-cors",
            body: JSON.stringify({ userId, gold, level, userName })
        });
    }

    function startMining() {
        if (isMining) return;
        const dur = parseInt(document.getElementById("duration").value) || 30;
        if (dur < 30) return alert("Th·ªùi gian ƒë√†o t·ªëi thi·ªÉu l√† 30 gi√¢y!");

        isMining = true;
        let elapsed = 0;
        const btn = document.getElementById("btn-mine");
        const prog = document.getElementById("prog-fill");
        const status = document.getElementById("status");

        btn.disabled = true;
        status.innerText = "‚õè ƒêang ƒë√†o v√†ng...";
        
        let timer = setInterval(() => {
            elapsed++;
            let p = (elapsed / dur) * 100;
            prog.style.width = p + "%";
            
            // C·ªông v√†ng m·ªói gi√¢y d·ª±a tr√™n s·ª©c m·∫°nh c√¥ng c·ª•
            gold += (TOOLS[level]?.power || 10);
            document.getElementById("gold").innerText = gold.toLocaleString();

            if (elapsed >= dur) {
                clearInterval(timer);
                isMining = false;
                btn.disabled = false;
                prog.style.width = "0%";
                status.innerText = "‚úÖ Ho√†n th√†nh! ƒê√£ l∆∞u v√†ng.";
                saveData(); // L∆∞u v√†o Google Sheets
                tg.HapticFeedback.notificationOccurred('success');
            }
        }, 1000);
    }

    function updateWdPlaceholder() {
        const method = document.getElementById("wd-method").value;
        document.getElementById("wd-acc").placeholder = method === "Momo" ? "S·ªë ƒëi·ªán tho·∫°i Momo" : "S·ªë t√†i kho·∫£n + T√™n ng√¢n h√†ng";
    }

    async function sendWithdraw(e) {
        e.preventDefault();
        if (gold < 20000) return alert("B·∫°n c·∫ßn t·ªëi thi·ªÉu 20,000 v√†ng!");

        const method = document.getElementById("wd-method").value;
        const acc = document.getElementById("wd-acc").value;
        const name = document.getElementById("wd-name").value;

        const msg = `üîî Y√äU C·∫¶U R√öT TI·ªÄN\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüë§ Kh√°ch: ${userName}\nüÜî ID: ${userId}\nüè¶ Lo·∫°i: ${method}\nüí≥ STK: ${acc}\nüë§ T√™n: ${name}\nüí∞ V√†ng r√∫t: 20,000\nüíµ Ti·ªÅn nh·∫≠n: 10,000 VNƒê`;

        try {
            await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_id: CHAT_ID, text: msg })
            });

            gold -= 20000;
            saveData();
            alert("‚úÖ ƒê√£ g·ª≠i y√™u c·∫ßu! Admin s·∫Ω duy·ªát v√† chuy·ªÉn ti·ªÅn cho b·∫°n.");
            showTab('mine');
        } catch (err) {
            alert("L·ªói khi g·ª≠i y√™u c·∫ßu. Vui l√≤ng th·ª≠ l·∫°i!");
        }
    }

    function showTab(t) {
        document.querySelectorAll('.tab').forEach(el => el.style.display = 'none');
        document.getElementById('tab-' + t).style.display = 'block';
        document.querySelectorAll('.nav div').forEach(el => el.classList.remove('active'));
        document.getElementById('n-' + t).classList.add('active');
    }

    // Kh·ªüi t·∫°o game
    loadData();
</script>
</body>
</html>
