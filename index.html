<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GOLD MINER PRO V14.7</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --gold: #ffca28; --bg: #0d1117; --card: #161b22; --border: #30363d; --text: #e6edf3; --success: #238636; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); user-select: none; }
        
        #loader { position: fixed; inset: 0; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top: 4px solid var(--gold); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--success); color: white; padding: 12px 25px; border-radius: 12px; display: none; z-index: 10001; font-weight: bold; width: 80%; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }

        .header { background: #1c2128; padding: 15px; text-align: center; border-bottom: 2px solid var(--gold); position: sticky; top: 0; z-index: 999; }
        .gold-ui { font-size: 32px; font-weight: 900; color: var(--gold); text-shadow: 0 0 10px rgba(255,202,40,0.3); }

        .tab { display: none; padding: 15px 15px 100px 15px; animation: fadeIn 0.4s ease; }
        .tab.active { display: block !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card); border-radius: 20px; padding: 20px; margin-bottom: 15px; border: 1px solid var(--border); position: relative; }

        /* Miner Visuals */
        .miner-stage { height: 160px; display: flex; align-items: center; justify-content: center; position: relative; }
        .miner-man { font-size: 70px; z-index: 2; }
        .axe-hand { font-size: 45px; position: absolute; top: 25px; right: 32%; transform-origin: bottom left; z-index: 3; }
        .mining-active { animation: swingAxe 0.4s infinite; }
        @keyframes swingAxe { 0%, 100% { transform: rotate(0deg); } 50% { transform: rotate(-45deg); } }

        .particle { position: absolute; color: var(--gold); font-size: 20px; pointer-events: none; animation: popUp 0.8s forwards; }
        @keyframes popUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-120px); opacity: 0; } }

        /* BUTTON 3D - KH√îI PH·ª§C */
        .btn-3d { 
            background: var(--gold); border: none; padding: 16px; border-radius: 14px; width: 100%; 
            font-weight: bold; color: #000; cursor: pointer; box-shadow: 0 5px 0 #b38600; 
            font-size: 16px; margin: 10px 0; transition: all 0.1s; display: block;
        }
        .btn-3d:active { transform: translateY(3px); box-shadow: 0 2px 0 #b38600; }
        .btn-3d:disabled { background: #444; box-shadow: none; color: #888; transform: none; }

        /* CH√ö TH√çCH & L∆ØU √ù - M·ªöI */
        .note-container { 
            background: rgba(0,0,0,0.3); border-radius: 12px; border: 1px dashed #555; 
            padding: 12px; margin-top: 15px; text-align: left; 
        }
        .note-title { color: var(--gold); font-weight: bold; font-size: 13px; margin-bottom: 5px; display: flex; align-items: center; }
        .note-item { font-size: 12px; color: #8b949e; line-height: 1.6; display: block; }

        .progress-container { background: #000; height: 14px; border-radius: 7px; margin: 15px 0; border: 1px solid var(--border); overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #ffca28, #ffd54f); transition: width 0.2s linear; }

        .nav { position: fixed; bottom: 0; width: 100%; display: flex; background: #161b22; border-top: 1px solid var(--border); padding-bottom: env(safe-area-inset-bottom); z-index: 999; }
        .nav-item { flex: 1; text-align: center; padding: 16px 5px; font-size: 11px; color: #8b949e; }
        .nav-item.active { color: var(--gold); font-weight: bold; border-top: 2px solid var(--gold); background: rgba(255,202,40,0.05); }

        .rank-row { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #222; align-items: center; }
        .shop-row { background: #0d1117; padding: 15px; border-radius: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); }
        input, select { width: 100%; padding: 14px; margin: 8px 0; border-radius: 12px; background: #0d1117; color: #fff; border: 1px solid var(--border); box-sizing: border-box; }
    </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><p style="margin-top:15px; font-weight:bold;">ƒêANG ƒê·ªíNG B·ªò...</p></div>
<div id="toast"></div>

<div class="header">
    <div id="display-name" style="font-size: 13px; color: #8b949e; margin-bottom: 4px;">@Miner</div>
    <div class="gold-ui" id="display-gold">0</div>
</div>

<div id="tab-mine" class="tab active">
    <div class="card" id="checkin-box" style="display:none;">
        <button class="btn-3d" style="background:var(--success); box-shadow:0 5px 0 #1a6328;" onclick="doCheckin()">üéÅ ƒêI·ªÇM DANH (+2,000 V√ÄNG)</button>
    </div>
    
    <div class="card" style="text-align:center;">
        <div id="mining-status-text" style="font-weight:bold; color:var(--gold); font-size:22px; height:32px; margin-bottom:5px;">
            <span id="live-gold-box" style="display:none;">+ <span id="live-val">0</span> üü°</span>
        </div>
        
        <div class="miner-stage">
            <span class="miner-man">üë®‚Äçüåæ</span>
            <span id="axe-img" class="axe-hand">ü™µ</span>
        </div>

        <h2 id="tool-txt" style="color:var(--gold); margin:8px 0; text-transform: uppercase; font-size: 18px;">ƒêANG T·∫¢I...</h2>
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;">
            <span style="font-size:14px; font-weight: bold;">H·∫∏N GI·ªú (GI√ÇY):</span>
            <input type="number" id="mine-duration" value="30" style="width:80px; text-align:center; margin:0; padding:10px;">
        </div>

        <div class="progress-container"><div class="progress-bar" id="prog-fill"></div></div>
        <button class="btn-3d" id="btn-start" onclick="startMining()">‚õè B·∫ÆT ƒê·∫¶U KHAI TH√ÅC</button>

        <div class="note-container">
            <div class="note-title">‚ö†Ô∏è L∆ØU √ù QUAN TR·ªåNG:</div>
            <span class="note-item">‚Ä¢ <b>Treo m√°y:</b> B·∫°n c√≥ th·ªÉ ƒë√≥ng App, h·ªá th·ªëng v·∫´n ƒë√†o ƒë·ªß th·ªùi gian.</span>
            <span class="note-item">‚Ä¢ <b>N√¢ng c·∫•p:</b> Cu·ªëc c√†ng x·ªãn, s·ªë v√†ng nh·∫≠n ƒë∆∞·ª£c m·ªói gi√¢y c√†ng cao.</span>
            <span class="note-item">‚Ä¢ <b>Thanh to√°n:</b> R√∫t ti·ªÅn s·∫Ω ƒë∆∞·ª£c duy·ªát trong v√≤ng 24h.</span>
        </div>
    </div>
</div>

<div id="tab-shop" class="tab">
    <div class="card">
        <h3 style="margin-top:0; color:var(--gold);">üõí C·ª¨A H√ÄNG CU·ªêC</h3>
        <div id="shop-list"></div>
    </div>
</div>

<div id="tab-spin" class="tab">
    <div class="card" style="text-align:center;">
        <h3>üé° V√íNG QUAY MAY M·∫ÆN</h3>
        <canvas id="wheel" width="300" height="300" style="width:260px; border-radius:50%; transition:4s cubic-bezier(0.1,0,0.1,1); border:6px solid #1c2128;"></canvas>
        <p style="font-size:18px; margin-top:15px;">L∆∞·ª£t quay: <b id="spin-qty" style="color:var(--gold);">0</b></p>
        <button class="btn-3d" onclick="spinNow()">QUAY NGAY</button>
    </div>
</div>

<div id="tab-task" class="tab">
    <div class="card">
        <h3>üèÜ B·∫¢NG X·∫æP H·∫†NG</h3>
        <div id="leaderboard"></div>
    </div>
</div>

<div id="tab-wallet" class="tab">
    <div class="card">
        <h3>üí∞ R√öT TI·ªÄN</h3>
        <input type="number" id="wd-gold" placeholder="S·ªë v√†ng">
        <select id="wd-type"><option value="Momo">MoMo</option><option value="Bank">Ng√¢n h√†ng</option></select>
        <input type="text" id="wd-info" placeholder="S·ªë t√†i kho·∫£n / S·ªë MoMo">
        <input type="text" id="wd-name" placeholder="T√™n ch·ªß t√†i kho·∫£n">
        <button class="btn-3d" onclick="sendWd()">X√ÅC NH·∫¨N R√öT</button>
    </div>
</div>

<nav class="nav">
    <div class="nav-item active" onclick="nav('tab-mine', this)">‚õè ƒê√ÄO</div>
    <div class="nav-item" onclick="nav('tab-shop', this)">üõí SHOP</div>
    <div class="nav-item" onclick="nav('tab-spin', this)">üé° QUAY</div>
    <div class="nav-item" onclick="nav('tab-task', this)">üèÜ TOP</div>
    <div class="nav-item" onclick="nav('tab-wallet', this)">üí∞ V√ç</div>
</nav>

<script>
    const tg = window.Telegram.WebApp;
    // URL KH√îNG ƒê·ªîI
    const API = "https://script.google.com/macros/s/AKfycbz3_5RmFs0zzKXlc83p6QqzFUueq7kag6cTz45DXTVipvgiKTOoLsjOCLh9g4AIl4d8/exec";
    const uId = tg.initDataUnsafe?.user?.id || "dev_user";
    const uName = tg.initDataUnsafe?.user?.username || "Th·ª£ M·ªè";

    let gold = 0, level = 0, spins = 0, mining = false;
    const TOOLS = [
        {n:"Cu·ªëc G·ªó",p:10,c:0, i:"ü™µ"}, {n:"Cu·ªëc ƒê√°",p:35,c:15000, i:"ü™®"},
        {n:"Cu·ªëc ƒê·ªìng",p:90,c:65000, i:"ü•â"}, {n:"Cu·ªëc S·∫Øt",p:250,c:280000, i:"üõ†"},
        {n:"Cu·ªëc V√†ng",p:600,c:1200000, i:"üî±"}, {n:"Cu·ªëc Kim C∆∞∆°ng",p:1500,c:5500000, i:"üíé"}
    ];

    async function init() {
        try {
            const r = await fetch(`${API}?userId=${uId}`);
            const d = await r.json();
            gold = d.gold; level = d.level; spins = d.extraSpin;
            checkOffline(d);
            if (new Date(d.lastCheckIn).toDateString() !== new Date().toDateString()) document.getElementById('checkin-box').style.display='block';
            renderRanks(d.ranks); ui(); drawWheel();
            document.getElementById('loader').style.display = 'none';
        } catch(e) { console.log(e); }
    }

    function ui() {
        document.getElementById('display-gold').innerText = Math.floor(gold).toLocaleString();
        document.getElementById('display-name').innerText = "@" + uName;
        document.getElementById('tool-txt').innerText = TOOLS[level].n;
        document.getElementById('spin-qty').innerText = spins;
        document.getElementById('axe-img').innerText = TOOLS[level].i;
        document.getElementById('shop-list').innerHTML = TOOLS.map((t,idx)=>`
            <div class="shop-row">
                <div><b>${t.i} ${t.n}</b><br><small style="color:#8b949e">+${t.p}/s</small></div>
                <button class="btn-3d" style="width:105px;margin:0;padding:10px;font-size:12px;" ${level>=idx?'disabled':''} onclick="buy(${idx},${t.c})">
                    ${level>=idx?'ƒê√É C√ì':t.c.toLocaleString()}
                </button>
            </div>`).join('');
    }

    function checkOffline(d) {
        if(d.lastMineStart > 0 && d.mineDuration > 0) {
            let passed = Math.floor((Date.now() - d.lastMineStart)/1000);
            if(passed >= d.mineDuration) {
                let g = d.mineDuration * TOOLS[d.level].p;
                gold += g; save(); toast(`+${g.toLocaleString()} V√†ng (Offline)`);
                fetch(API,{method:"POST",mode:"no-cors",body:JSON.stringify({action:"start_mine",userId:uId,startTime:0,duration:0})});
            } else { startMining(passed, d.mineDuration); }
        }
    }

    function startMining(resume = 0, total = 0) {
        if(mining && resume === 0) return;
        const dur = total || Math.max(10, parseInt(document.getElementById('mine-duration').value) || 30);
        mining = true;
        const btn = document.getElementById('btn-start');
        const axe = document.getElementById('axe-img');
        btn.disabled = true; axe.classList.add('mining-active');
        document.getElementById('live-gold-box').style.display = 'block';
        if(resume === 0) fetch(API,{method:"POST",mode:"no-cors",body:JSON.stringify({action:"start_mine",userId:uId,startTime:Date.now(),duration:dur})});
        let c = resume;
        let t = setInterval(() => {
            c++;
            document.getElementById('live-val').innerText = (c * TOOLS[level].p).toLocaleString();
            document.getElementById('prog-fill').style.width = (c/dur)*100 + "%";
            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
            popGold();
            if(c >= dur) {
                clearInterval(t); mining = false; btn.disabled = false; axe.classList.remove('mining-active');
                document.getElementById('live-gold-box').style.display = 'none';
                gold += (dur * TOOLS[level].p); ui(); save();
                fetch(API,{method:"POST",mode:"no-cors",body:JSON.stringify({action:"start_mine",userId:uId,startTime:0,duration:0})});
                toast("ƒê√£ ƒë√†o xong!");
            }
        }, 1000);
    }

    function popGold() {
        const stage = document.querySelector('.miner-stage');
        const p = document.createElement('div');
        p.className = 'particle'; p.innerText = 'üü°';
        p.style.left = (Math.random()*40 + 30) + '%';
        stage.appendChild(p);
        setTimeout(()=>p.remove(), 800);
    }

    function renderRanks(ranks) {
        document.getElementById('leaderboard').innerHTML = ranks.map((r,i) => {
            let m = i===0?'ü•á':(i===1?'ü•à':(i===2?'ü•â':''));
            return `<div class="rank-row"><span><b>${m} ${i+1}.</b> ${r.name}</span><b>${r.gold.toLocaleString()}</b></div>`;
        }).join('');
    }

    function nav(id, el) { document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); el.classList.add('active'); }
    function buy(idx, cost) { if(gold < cost) return toast("Kh√¥ng ƒë·ªß v√†ng!"); gold -= cost; level = idx; ui(); save(); }
    function save() { fetch(API,{method:"POST",mode:"no-cors",body:JSON.stringify({action:"save",userId:uId,gold:gold,level:level,userName:uName})}); }
    function toast(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.display = 'block'; setTimeout(()=>t.style.display='none', 3000); }
    function spinNow() { if(spins<=0) return toast("H·∫øt l∆∞·ª£t!"); spins--; ui(); let d = 1800 + Math.random()*360; document.getElementById('wheel').style.transform = `rotate(${d}deg)`; setTimeout(()=>{ let prizes = [1000, 5000, 0, 2000, 10000, 500]; gold += prizes[Math.floor((360-(d%360))/60)%6]; ui(); save(); }, 4000); }
    function drawWheel() { const ctx = document.getElementById('wheel').getContext('2d'); const p = ["1K","5K","0","2K","10K","500"]; const c = ["#ffca28","#1c2128","#444","#ffca28","#1c2128","#ffca28"]; for(let i=0; i<6; i++) { ctx.fillStyle = c[i]; ctx.beginPath(); ctx.moveTo(150,150); ctx.arc(150,150,140,i*Math.PI/3,(i+1)*Math.PI/3); ctx.fill(); ctx.fillStyle="#fff"; ctx.font="bold 16px sans-serif"; ctx.save(); ctx.translate(150,150); ctx.rotate(i*Math.PI/3 + Math.PI/6); ctx.fillText(p[i], 85, 8); ctx.restore(); } }
    function sendWd() { let amt = parseInt(document.getElementById('wd-gold').value); if(gold < amt) return toast("Kh√¥ng ƒë·ªß v√†ng!"); fetch(API,{method:"POST",mode:"no-cors",body:JSON.stringify({action:"withdraw",userId:uId,amount:amt,method:document.getElementById('wd-type').value,info:document.getElementById('wd-info').value+" ("+document.getElementById('wd-name').value+")"})}); gold -= amt; ui(); toast("Y√™u c·∫ßu th√†nh c√¥ng!"); }

    init();
    tg.expand();
</script>
</body>
</html>
