<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‚õè ƒê√†o V√†ng Master</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --p: #ffb703; --s: #fb8500; --bg: #f8f9fa; --txt: #023047; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--txt); user-select: none; }
        .header { background: var(--p); padding: 15px; text-align: center; font-weight: bold; font-size: 18px; }
        .content { padding: 15px 15px 80px; }
        .card { background: #fff; padding: 20px; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); text-align: center; }
        .gold-val { font-size: 36px; color: var(--s); font-weight: 900; margin: 10px 0; }
        .prog-bg { background: #eee; height: 12px; border-radius: 6px; overflow: hidden; margin: 15px 0; border: 1px solid #ddd; }
        .prog-fill { background: linear-gradient(90deg, var(--p), var(--s)); height: 100%; width: 0%; }
        .btn { background: var(--p); border: none; padding: 15px; border-radius: 12px; width: 100%; font-weight: bold; font-size: 16px; cursor: pointer; box-shadow: 0 4px 0 #e6a700; }
        .btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #e6a700; }
        .btn:disabled { background: #ccc; box-shadow: none; color: #888; }
        .nav { position: fixed; bottom: 0; width: 100%; display: flex; background: #fff; border-top: 1px solid #eee; padding-bottom: env(safe-area-inset-bottom); }
        .nav div { flex: 1; text-align: center; padding: 15px; font-size: 12px; color: #888; font-weight: bold; }
        .nav .active { color: var(--s); border-top: 3px solid var(--s); }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="header">‚õè ƒê√ÄO V√ÄNG MASTER</div>

<div class="content">
    <div id="tab-mine" class="tab">
        <div class="card">
            <div id="tool-name" style="font-size: 14px; background: #eee; display: inline-block; padding: 3px 10px; border-radius: 10px;">ƒêang t·∫£i...</div>
            <div id="gold" class="gold-val">0</div>
            <div id="status" style="font-size:14px; color:#666">S·∫µn s√†ng</div>
            <div class="prog-bg"><div id="prog-fill" class="prog-fill"></div></div>
            <button class="btn" id="btn-mine" onclick="startMining()">B·∫ÆT ƒê·∫¶U ƒê√ÄO</button>
        </div>
        <div class="card">
            <label style="font-size:13px; font-weight:bold; display:block; text-align:left">‚è± Gi√¢y m·ªói ƒë·ª£t:</label>
            <input type="number" id="duration" value="30" min="30">
        </div>
    </div>

    <div id="tab-reward" class="tab" style="display:none">
        <div class="card">
            <h3>üíé R√∫t Ti·ªÅn</h3>
            <form onsubmit="sendWithdraw(event)">
                <select id="wd-method">
                    <option value="Momo">V√≠ Momo</option>
                    <option value="Bank">Ng√¢n h√†ng</option>
                </select>
                <input type="text" id="wd-acc" placeholder="S·ªë ƒëi·ªán tho·∫°i / STK" required>
                <input type="text" id="wd-name" placeholder="T√™n ch·ªß t√†i kho·∫£n" required>
                <button type="submit" class="btn">G·ª¨I Y√äU C·∫¶U</button>
            </form>
        </div>
    </div>
</div>

<div class="nav">
    <div onclick="showTab('mine')" id="n-mine" class="active">‚õè ƒê√ÄO</div>
    <div onclick="showTab('reward')" id="n-reward">üíé R√öT</div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // LINK GOOGLE WEB APP C·ª¶A B·∫†N
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwi5oG87Gsd2PQMVhiQLVnYX6pWEP3DEMXzgro8vea9DfDqbXV4dagMiNmkWyOuAavk/exec"; 
    const BOT_TOKEN = "8287339175:AAFMUbs8q8ez3Hthk7swEvpcWEEdhljhYWM";
    const CHAT_ID = "-1003681995490";

    let gold = 0;
    let level = 0;
    let isMining = false;
    const userId = tg.initDataUnsafe?.user?.id || "guest_test";
    const userName = tg.initDataUnsafe?.user?.username || "Guest";

    const TOOLS = [{ name: "Cu·ªëc G·ªó", power: 10 }, { name: "Cu·ªëc S·∫Øt", power: 30 }];

    async function loadData() {
        try {
            let res = await fetch(`${SCRIPT_URL}?userId=${userId}`);
            let data = await res.json();
            gold = parseInt(data.gold) || 0;
            level = parseInt(data.level) || 0;
            updateUI();
        } catch (e) { document.getElementById("tool-name").innerText = "L·ªói k·∫øt n·ªëi database!"; }
    }

    function updateUI() {
        document.getElementById("gold").innerText = gold.toLocaleString();
        document.getElementById("tool-name").innerText = "C√¥ng c·ª•: " + (TOOLS[level]?.name || "C∆° b·∫£n");
    }

    function saveData() {
        fetch(SCRIPT_URL, {
            method: "POST",
            mode: "no-cors",
            body: JSON.stringify({ userId, gold, level, userName })
        });
    }

    function startMining() {
        if (isMining) return;
        const dur = parseInt(document.getElementById("duration").value) || 30;
        isMining = true;
        let elapsed = 0;
        document.getElementById("btn-mine").disabled = true;
        document.getElementById("status").innerText = "‚õè ƒêang ƒë√†o...";

        let timer = setInterval(() => {
            elapsed++;
            document.getElementById("prog-fill").style.width = (elapsed / dur) * 100 + "%";
            gold += (TOOLS[level]?.power || 10);
            document.getElementById("gold").innerText = gold.toLocaleString();

            if (elapsed >= dur) {
                clearInterval(timer);
                isMining = false;
                document.getElementById("btn-mine").disabled = false;
                document.getElementById("prog-fill").style.width = "0%";
                document.getElementById("status").innerText = "‚úÖ ƒê√£ xong!";
                saveData(); // L∆∞u l√™n Google Sheets
                tg.HapticFeedback.notificationOccurred('success');
            }
        }, 1000);
    }

    async function sendWithdraw(e) {
        e.preventDefault();
        if (gold < 20000) return alert("Kh√¥ng ƒë·ªß 20,000 v√†ng!");
        const method = document.getElementById("wd-method").value;
        const acc = document.getElementById("wd-acc").value;
        const name = document.getElementById("wd-name").value;
        const msg = `üîî R√öT TI·ªÄN: ${userName}\nID: ${userId}\nLo·∫°i: ${method}\nSTK: ${acc}\nTen: ${name}\nV√†ng: 20k`;

        await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chat_id: CHAT_ID, text: msg })
        });

        gold -= 20000;
        saveData();
        alert("G·ª≠i y√™u c·∫ßu th√†nh c√¥ng!");
    }

    function showTab(t) {
        document.querySelectorAll('.tab').forEach(el => el.style.display = 'none');
        document.getElementById('tab-' + t).style.display = 'block';
        document.querySelectorAll('.nav div').forEach(el => el.classList.remove('active'));
        document.getElementById('n-' + t).classList.add('active');
    }

    loadData();
</script>
</body>
</html>
