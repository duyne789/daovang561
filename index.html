<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GOLD MINER PRO - PREMIUM</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --gold: #ffca28; --bg: #0d1117; --card: #1c2128; --border: #30363d; --text: #f0f6fc; --accent: #58a6ff; --neon: 0 0 10px rgba(255, 202, 40, 0.5); }
        body { margin: 0; font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); user-select: none; overflow-x: hidden; }
        
        /* Loading Screen */
        #loader { position: fixed; inset: 0; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; }
        .spinner { width: 50px; height: 50px; border: 5px solid #30363d; border-top: 5px solid var(--gold); border-radius: 50%; animation: spin 1s linear infinite; box-shadow: var(--neon); }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Toast */
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(35, 134, 54, 0.9); color: white; padding: 15px 30px; border-radius: 20px; display: none; z-index: 10001; font-weight: bold; backdrop-filter: blur(5px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }

        /* Header */
        .header { background: rgba(22, 27, 34, 0.8); backdrop-filter: blur(10px); padding: 20px; text-align: center; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 999; }
        .gold-display { font-size: 38px; font-weight: 800; color: var(--gold); text-shadow: var(--neon); display: flex; align-items: center; justify-content: center; gap: 10px; }
        .gold-display i { font-size: 28px; }

        /* Tabs Layout */
        .tab { display: none; padding: 20px 15px 120px 15px; animation: slideUp 0.4s ease-out; }
        .tab.active { display: block !important; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Cards */
        .card { background: var(--card); border-radius: 24px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .card h3 { margin-top: 0; display: flex; align-items: center; gap: 10px; color: var(--gold); }

        /* Mining Area */
        .miner-stage { height: 180px; display: flex; align-items: center; justify-content: center; position: relative; background: radial-gradient(circle, rgba(255,202,40,0.05) 0%, transparent 70%); border-radius: 50%; margin: 20px 0; }
        .miner-man { font-size: 80px; z-index: 2; filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); }
        .axe-hand { font-size: 50px; position: absolute; top: 30px; right: 30%; transform-origin: bottom left; z-index: 3; }
        .mining-active { animation: swing 0.5s infinite; }
        @keyframes swing { 0%, 100% { transform: rotate(0deg); } 50% { transform: rotate(-45deg); } }

        /* UI Elements */
        .progress-container { background: #0d1117; height: 16px; border-radius: 8px; margin: 20px 0; overflow: hidden; border: 1px solid var(--border); }
        .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #ffca28, #f59e0b); box-shadow: var(--neon); transition: width 0.2s linear; }
        
        .btn-3d { background: linear-gradient(135deg, #ffca28, #f59e0b); border: none; padding: 18px; border-radius: 18px; width: 100%; font-weight: 800; color: #000; font-size: 16px; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 0 #b38600; text-transform: uppercase; letter-spacing: 1px; }
        .btn-3d:active { transform: translateY(2px); box-shadow: 0 2px 0 #b38600; }
        .btn-3d:disabled { background: #30363d; color: #8b949e; box-shadow: none; cursor: not-allowed; }

        input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 15px; background: #0d1117; color: #fff; border: 1px solid var(--border); outline: none; font-size: 16px; }
        input:focus { border-color: var(--gold); }

        /* Navigation */
        .nav { position: fixed; bottom: 0; width: 100%; display: flex; background: rgba(22, 27, 34, 0.95); backdrop-filter: blur(15px); border-top: 1px solid var(--border); padding-bottom: env(safe-area-inset-bottom); z-index: 999; }
        .nav-item { flex: 1; text-align: center; padding: 15px 5px; font-size: 11px; color: #8b949e; transition: 0.3s; }
        .nav-item i { font-size: 20px; display: block; margin-bottom: 5px; }
        .nav-item.active { color: var(--gold); background: rgba(255,202,40,0.05); }

        /* Shop & Rank Items */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(13, 17, 23, 0.5); border-radius: 15px; margin-bottom: 10px; border: 1px solid var(--border); }
        .list-info b { font-size: 16px; color: var(--gold); }
        
        /* Note Box */
        .note-box { background: rgba(88, 166, 255, 0.05); border-left: 4px solid var(--accent); padding: 15px; border-radius: 0 15px 15px 0; margin-top: 15px; font-size: 12px; line-height: 1.6; }
    </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><p style="margin-top:20px; font-weight:bold; letter-spacing:2px;">GOLD MINER SYSTEM...</p></div>
<div id="toast"></div>

<div class="header">
    <div id="display-name" style="color: #8b949e; margin-bottom: 5px; font-weight: 500;">@username</div>
    <div class="gold-display"><i class="fas fa-coins"></i> <span id="display-gold">0</span></div>
</div>

<div id="tab-mine" class="tab active">
    <div class="card" style="text-align:center;">
        <div id="mining-status" style="height:32px; font-weight:800; color:var(--gold); font-size:20px;">
            <span id="live-gold-box" style="display:none;">+<span id="live-val">0</span> <i class="fas fa-circle"></i></span>
        </div>
        <div class="miner-stage">
            <span class="miner-man">üë®‚Äçüåæ</span>
            <span id="axe-img" class="axe-hand">ü™µ</span>
        </div>
        <h2 id="tool-txt" style="margin:10px 0; font-weight:800; letter-spacing:1px;">ƒêANG T·∫¢I...</h2>
        <div style="display:flex; justify-content:space-between; align-items:center; background:#0d1117; padding:5px 15px; border-radius:15px; border:1px solid var(--border);">
            <span style="font-size:14px; color:#8b949e;">GI√ÇY ƒê√ÄO (Min 60s):</span>
            <input type="number" id="mine-duration" value="60" min="60" style="width:70px; border:none; margin:0; text-align:right; font-weight:bold; color:var(--gold);">
        </div>
        <div class="progress-container"><div class="progress-bar" id="prog-fill"></div></div>
        <button class="btn-3d" id="btn-start" onclick="startMining()"><i class="fas fa-hammer"></i> B·∫ÆT ƒê·∫¶U KHAI TH√ÅC</button>
        <div class="note-box">
            <b><i class="fas fa-info-circle"></i> TH√îNG TIN TREO M√ÅY:</b><br>
            ‚Ä¢ H·ªá th·ªëng t·ª± ch·∫°y khi b·∫°n tho√°t Telegram.<br>
            ‚Ä¢ V√†ng t·ª± c·ªông sau khi th·ªùi gian k·∫øt th√∫c.
        </div>
    </div>
</div>

<div id="tab-shop" class="tab">
    <div class="card">
        <h3><i class="fas fa-shopping-cart"></i> C·ª¨A H√ÄNG D·ª§NG C·ª§</h3>
        <div id="shop-list"></div>
    </div>
</div>

<div id="tab-deposit" class="tab">
    <div class="card" style="text-align:center;">
        <h3><i class="fas fa-wallet"></i> N·∫†P V√ÄNG</h3>
        <div style="background:#fff; padding:15px; border-radius:20px; display:inline-block; margin:15px 0; border:4px solid var(--gold);">
            <img id="qr-bank" src="" style="width:200px; display:block;">
        </div>
        <p style="font-size:14px; margin-bottom:5px;">Ng√¢n h√†ng: <b>MB BANK</b></p>
        <p style="font-size:14px; margin-top:0;">STK: <b style="color:var(--gold);">505051111</b></p>
        <div style="background:rgba(255,202,40,0.1); padding:15px; border-radius:15px; border:1px dashed var(--gold);">
            <p style="margin:0; font-size:13px; color:#8b949e;">N·ªòI DUNG CHUY·ªÇN KHO·∫¢N:</p>
            <p style="margin:5px 0 0 0; font-size:20px; font-weight:900; color:var(--gold);" id="deposit-id-display">...</p>
        </div>
    </div>
</div>

<div id="tab-task" class="tab">
    <div class="card" style="text-align:center;">
        <h3><i class="fas fa-users"></i> GI·ªöI THI·ªÜU B·∫†N B√à</h3>
        <p style="font-size:14px; color:#8b949e; line-height:1.6;">Nh·∫≠n ngay <b style="color:var(--gold);">5,000 v√†ng</b> v√† <b style="color:var(--gold);">+1 l∆∞·ª£t quay</b> khi m·ªùi b·∫°n b√® qua link b√™n d∆∞·ªõi.</p>
        <button class="btn-3d" onclick="invite()"><i class="fas fa-share-nodes"></i> CHIA S·∫∫ LINK NGAY</button>
    </div>
    <div class="card">
        <h3>üèÜ TOP ƒê·∫†I GIA</h3>
        <div id="rank-list">ƒêang t·∫£i b·∫£ng x·∫øp h·∫°ng...</div>
    </div>
</div>

<div id="tab-wallet" class="tab">
    <div class="card">
        <h3><i class="fas fa-money-bill-transfer"></i> R√öT TI·ªÄN (MIN 30K)</h3>
        <label style="font-size:13px; color:#8b949e;">S·ªë v√†ng mu·ªën r√∫t:</label>
        <input type="number" id="wd-gold" placeholder="V√≠ d·ª•: 30000">
        <label style="font-size:13px; color:#8b949e;">Th√¥ng tin nh·∫≠n ti·ªÅn (STK - Ng√¢n h√†ng):</label>
        <input type="text" id="wd-info" placeholder="0123... - MB BANK">
        <button class="btn-3d" onclick="sendWd()" style="margin-top:10px;">X√ÅC NH·∫¨N R√öT</button>
    </div>
</div>

<nav class="nav">
    <div class="nav-item active" onclick="nav('tab-mine', this)"><i class="fas fa-pickaxe"></i>ƒê√ÄO</div>
    <div class="nav-item" onclick="nav('tab-shop', this)"><i class="fas fa-store"></i>SHOP</div>
    <div class="nav-item" onclick="nav('tab-deposit', this)"><i class="fas fa-plus-circle"></i>N·∫†P</div>
    <div class="nav-item" onclick="nav('tab-task', this)"><i class="fas fa-trophy"></i>NHI·ªÜM V·ª§</div>
    <div class="nav-item" onclick="nav('tab-wallet', this)"><i class="fas fa-hand-holding-dollar"></i>V√ç</div>
</nav>

<script>
    const tg = window.Telegram.WebApp;
    // GI·ªÆ NGUY√äN API C·ª¶A B·∫†N
    const API = "https://script.google.com/macros/s/AKfycbz3_5RmFs0zzKXlc83p6QqzFUueq7kag6cTz45DXTVipvgiKTOoLsjOCLh9g4AIl4d8/exec";
    const uId = tg.initDataUnsafe?.user?.id || "dev_user";
    const uName = tg.initDataUnsafe?.user?.username || "Guest";

    let gold = 0, level = 0, spins = 0, mining = false;
    const TOOLS = [
        {n:"Cu·ªëc G·ªó",p:5,c:0,i:"ü™µ"}, {n:"Cu·ªëc ƒê√°",p:15,c:20000,i:"ü™®"},
        {n:"Cu·ªëc ƒê·ªìng",p:40,c:80000,i:"ü•â"}, {n:"Cu·ªëc S·∫Øt",p:100,c:300000,i:"üõ†"},
        {n:"Cu·ªëc V√†ng",p:250,c:1000000,i:"üî±"}, {n:"Cu·ªëc Kim C∆∞∆°ng",p:600,c:5000000,i:"üíé"}
    ];

    async function init() {
        try {
            const r = await fetch(`${API}?userId=${uId}`);
            const d = await r.json();
            gold = d.gold; level = d.level; spins = d.extraSpin;
            document.getElementById('deposit-id-display').innerText = uId;
            document.getElementById('qr-bank').src = `https://img.vietqr.io/image/mbbank-505051111-compact.png?amount=10000&addInfo=${uId}`;
            
            ui(); renderShop(); renderRank(d.ranks);
            checkOffline(d);
            document.getElementById('loader').style.display = 'none';
        } catch(e) { console.error(e); }
    }

    // GI·ªÆ NGUY√äN LOGIC REFBY V√Ä LINK CHU·∫®N
    function invite() {
        const inviteLink = `https://t.me/daovang51_bot/start?startapp=${uId}`;
        const shareText = "‚õè ƒê√†o v√†ng c√πng m√¨nh! Nh·∫≠n 5,000 v√†ng khi tham gia üí∞";
        tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(inviteLink)}&text=${encodeURIComponent(shareText)}`);
    }

    // LOGIC TREO M√ÅY OFFLINE
    function checkOffline(d) {
        if(d.lastMineStart > 0 && d.mineDuration > 0) {
            let elapsed = Math.floor((Date.now() - d.lastMineStart) / 1000);
            if(elapsed >= d.mineDuration) {
                let earned = d.mineDuration * TOOLS[d.level].p;
                gold += earned; save();
                fetch(API,{method:"POST",mode:"no-cors",body:JSON.stringify({action:"start_mine",userId:uId,startTime:0,duration:0})});
                toast(`Ch√†o m·ª´ng tr·ªü l·∫°i! B·∫°n ƒë√£ ƒë√†o ƒë∆∞·ª£c ${earned.toLocaleString()} v√†ng.`);
            } else { startMining(elapsed, d.mineDuration); }
        }
    }

    function startMining(resume = 0, total = 0) {
        if(mining && resume === 0) return;
        let dur = total || parseInt(document.getElementById('mine-duration').value);
        if(dur < 60 && resume === 0) return toast("Th·ªùi gian ƒë√†o t·ªëi thi·ªÉu 60 gi√¢y!");
        
        mining = true;
        document.getElementById('btn-start').disabled = true;
        document.getElementById('axe-img').classList.add('mining-active');
        document.getElementById('live-gold-box').style.display = 'inline';
        
        if(resume === 0) fetch(API,{method:"POST",mode:"no-cors",body:JSON.stringify({action:"start_mine",userId:uId,startTime:Date.now(),duration:dur})});
        
        let c = resume;
        let t = setInterval(() => {
            c++;
            document.getElementById('live-val').innerText = (c * TOOLS[level].p).toLocaleString();
            document.getElementById('prog-fill').style.width = (c/dur)*100 + "%";
            if(c >= dur) {
                clearInterval(t); mining = false; 
                document.getElementById('btn-start').disabled = false;
                document.getElementById('axe-img').classList.remove('mining-active');
                document.getElementById('live-gold-box').style.display = 'none';
                gold += (dur * TOOLS[level].p); ui(); save();
                fetch(API,{method:"POST",mode:"no-cors",body:JSON.stringify({action:"start_mine",userId:uId,startTime:0,duration:0})});
                toast("ƒê√£ thu ho·∫°ch v√†ng th√†nh c√¥ng!");
            }
        }, 1000);
    }

    function renderShop() {
        let h = "";
        TOOLS.forEach((t, i) => {
            if(i > 0) h += `<div class="list-item">
                <div class="list-info"><b>${t.i} ${t.n}</b><br><small style="color:#8b949e">T·ªëc ƒë·ªô: ${t.p}/s</small></div>
                <button class="btn-3d" style="width:110px; padding:10px; font-size:12px;" onclick="buyTool(${i})">${level >= i ? 'ƒê√É S·ªû H·ªÆU' : t.c.toLocaleString()}</button>
            </div>`;
        });
        document.getElementById('shop-list').innerHTML = h;
    }

    function buyTool(i) {
        if(level >= i) return toast("B·∫°n ƒë√£ c√≥ d·ª•ng c·ª• n√†y!");
        if(gold < TOOLS[i].c) return toast("B·∫°n kh√¥ng ƒë·ªß v√†ng!");
        gold -= TOOLS[i].c; level = i; ui(); renderShop(); save();
        toast("N√¢ng c·∫•p th√†nh c√¥ng!");
    }

    function renderRank(ranks) {
        if(!ranks) return;
        let h = ranks.map((r, i) => `<div class="list-item">
            <span><b>#${i+1}</b> ${r.name}</span>
            <b style="color:var(--gold)">${r.gold.toLocaleString()} <i class="fas fa-circle"></i></b>
        </div>`).join('');
        document.getElementById('rank-list').innerHTML = h;
    }

    function ui() {
        document.getElementById('display-gold').innerText = Math.floor(gold).toLocaleString();
        document.getElementById('display-name').innerText = "@" + uName;
        document.getElementById('tool-txt').innerText = TOOLS[level].n;
        document.getElementById('axe-img').innerText = TOOLS[level].i;
    }

    function nav(id, el) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
    }

    function save() {
        const refBy = tg.initDataUnsafe?.start_param || "";
        fetch(API,{method:"POST",mode:"no-cors",body:JSON.stringify({action:"save",userId:uId,gold:gold,level:level,userName:uName,refBy:refBy})});
    }

    function sendWd() {
        let a = parseInt(document.getElementById('wd-gold').value);
        let info = document.getElementById('wd-info').value;
        if(a < 30000) return toast("S·ªë ti·ªÅn r√∫t t·ªëi thi·ªÉu l√† 30,000 v√†ng!");
        if(gold < a) return toast("S·ªë d∆∞ kh√¥ng ƒë·ªß!");
        if(!info) return toast("Vui l√≤ng ƒëi·ªÅn th√¥ng tin ng√¢n h√†ng!");
        
        fetch(API,{method:"POST",mode:"no-cors",body:JSON.stringify({action:"withdraw",userId:uId,amount:a,info:info})});
        gold -= a; ui(); toast("Y√™u c·∫ßu r√∫t ti·ªÅn ƒë√£ ƒë∆∞·ª£c g·ª≠i!");
    }

    function toast(m) {
        const t = document.getElementById('toast');
        t.innerText = m; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 3000);
    }

    init();
    tg.expand();
</script>
</body>
</html>
